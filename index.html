<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Just Bitcoin</title>
		<meta name="description" content="Bitcoin price. Nothing more." />
		<link rel="shortcut icon" href="icon/favicon.svg" />
		<link rel="manifest" href="webmanifest.json" />
		<meta property="og:image:width" content="1200" />
		<meta property="og:image:height" content="630" />
		<meta
			property="og:image"
			content="https://api.apiflash.com/v1/urltoimage?access_key=a3d01743a9a04ac68f04adf0038bfdfb&format=jpeg&height=630&response_type=image&ttl=86400&url=https%3A%2F%2Fjust-bitcoin.eu%2F&width=1200"
		/>
		<meta name="color-scheme" content="light dark" />
		<meta
			name="theme-color"
			media="(prefers-color-scheme: light)"
			content="white"
		/>
		<meta
			name="theme-color"
			media="(prefers-color-scheme: dark)"
			content="black"
		/>
		<link
			href="https://fonts.googleapis.com/css2?family=Open+Sans&display=block"
			rel="stylesheet"
		/>
		<style>
			body {
				color: black;
				background-color: white;
				font-size: 20vw;
				font-family: 'Open Sans', sans-serif;
			}

			@media (min-aspect-ratio: 12/5) {
				body {
					font-size: 48vh;
				}
			}

			@media (prefers-color-scheme: dark) {
				body {
					color: white;
					background-color: black;
				}
			}

			.price {
				position: fixed;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				display: flex;
				justify-content: center;
				align-items: center;
				font-variant-numeric: tabular-nums;
				font-size: 1em;
			}

			.symbol:not(:empty) {
				margin-right: 0.15em;
			}

			.freshness {
				position: fixed;
				bottom: 0.5em;
				right: 0.5em;
				line-height: 1;
				font-size: max(0.875rem, 0.01em);
				opacity: 0.5;
				transition: opacity 0.2s;
			}
			.freshness:empty {
				opacity: 0;
			}
		</style>
	</head>

	<body>
		<div class="price">
			<span class="symbol"></span>
			<span class="value">…</span>
		</div>
		<span class="freshness">23:58</span>
		<script>
			;(function () {
				const $symbol = document.querySelector('.symbol')
				const $value = document.querySelector('.value')
				const formatter = new Intl.NumberFormat('en-US', {
					maximumFractionDigits: 0,
				})
				const currencySymbols = {
					USD: '$',
					EUR: '€',
					GBP: '£',
				}
				const currency =
					new URLSearchParams(window.location.search).get('currency') ||
					localStorage.getItem('currency') ||
					'USD'
				localStorage.setItem('currency', currency)

				$symbol.textContent = currencySymbols[currency]

				async function delay(time) {
					return new Promise((resolve) => {
						setTimeout(() => resolve(), time)
					})
				}

				const freshnessHandler = (() => {
					let timer = null
					const $freshness = document.querySelector('.freshness')
					let lastUpdate = new Date()

					function setDate(date) {
						lastUpdate = date
						update()
					}

					function update() {
						clearTimeout(timer)

						const now = new Date()
						const difference = now.getTime() - lastUpdate.getTime()

						const isStale = difference > 3 * 60 * 1000

						$freshness.textContent = isStale
							? `Last update ${lastUpdate.toLocaleString()}`
							: ``

						timer = setTimeout(update, 2000)
					}

					return {
						setDate,
					}
				})()

				const valueHandler = (() => {
					let timer = null
					async function update() {
						stop()
						let nextUpdateDelay =
							document.visibilityState === 'visible' ? 15000 : 60000
						try {
							const response = await fetch(
								'https://api.coindesk.com/v1/bpi/currentprice.json',
							)
							const data = await response.json()
							$value.textContent = formatter.format(
								data.bpi[currency].rate_float,
							)

							freshnessHandler.setDate(new Date(data.time.updatedISO))
						} catch (error) {
							console.error(error)
							nextUpdateDelay = 5000
						}
						timer = setTimeout(update, nextUpdateDelay)
					}
					function stop() {
						clearTimeout(timer)
						timer = null
					}

					update()

					return { update, stop }
				})()

				document.addEventListener('selectionchange', () => {
					const isSomethingSelected = !document.getSelection().isCollapsed
					if (isSomethingSelected) {
						valueHandler.stop()
					} else {
						valueHandler.update()
					}
				})

				document.addEventListener('visibilitychange', async () => {
					if (document.visibilityState === 'visible') {
						await valueHandler.update()
					}
				})

				window.addEventListener('online', async () => {
					await valueHandler.update()
				})

				if ('serviceWorker' in navigator) {
					navigator.serviceWorker
						.register('serviceWorker.js')
						.then(async (registration) => {
							const status = await navigator.permissions.query({
								name: 'periodic-background-sync',
							})
							if (status.state === 'granted') {
								try {
									await registration.periodicSync.register('get-latest-price', {
										minInterval: 24 * 60 * 60 * 1000,
									})
								} catch (error) {
									console.error(error)
								}
							}
						})
				}

				async function runWakeLock() {
					let wakeLock = null
					async function requestWakeLock() {
						try {
							wakeLock = await navigator.wakeLock.request('screen')
						} catch (error) {
							console.error(error)
						}
						if (wakeLock) {
							wakeLock.addEventListener('release', () => {
								wakeLock = null
							})
						}
					}
					await requestWakeLock()
					document.addEventListener('visibilitychange', async () => {
						if (wakeLock === null && document.visibilityState === 'visible') {
							await requestWakeLock()
						}
					})
				}

				if ('wakeLock' in navigator) {
					runWakeLock()
				}
			})()
		</script>
	</body>
</html>
